<html>
<head>
<title>MazeGame</title>
<style>
td {
  width: 15px;
  height: 25px;
}
td.wall {
  background-color: gray;
}
td.player {
  background-color: green;
}
td.enemy {
  background-color: red;
}
td.fruit {
  background-color: yellow;
}

</style>
</head>

<body>
<div>
<label>Введите ширину</label>
<input id="width" type="number"/>
</div>
<div>
<label>Введите высоту</label>
<input id="height" type="number"/>
</div>
<div>
<label>Введите количество врагов</label>
<input id="enemyCnt" type="number"/>
</div>
<div>
<label>Введите количество фруктов</label>
<input id="fruitsCnt" type="number"/>
</div>
<input type="button" onclick="start()" value="Начать"/>
<input type="button" onclick="stop()" value="Остановить"/>
<table id="GameFieald" width="100%">
<tr>
<td>
<table id="mytable1" border='1px' cellpadding='5px' cellspacing='0px'>
</table>
</td>
<td>
<table id="mytable2" border='1px' cellpadding='5px' cellspacing='0px'></table>
</td>
</tr>
</table>


<script type='text/javascript'>
function Maze () {
return maze = {
  width: 0,
  height: 0,
  field: [],
  dist: [],
  move: [-1, 0, 1, 0, 0, 1, 0, -1],
  enemiesCnt: 0,
  fruitsCnt: 0,
  enemiesCoords: [],
  score: 0,
  target: null,
  keys: null,
  player:  {
    y: 0,
    x: 0
  },
  init: function () {
    this.width = parseInt(document.getElementById('width').value);
    this.height = parseInt(document.getElementById('height').value);
    this.enemiesCnt = parseInt(document.getElementById('enemyCnt').value);
    this.fruitsCnt = parseInt(document.getElementById('fruitsCnt').value);
    this.field = [];
    this.dist = [];
    this.score = 0;
    this.enemiesCoords = [];
    for (var j = 0; j < this.height; j++) {
      var row = [], row_d = [];
      for (var i = 0; i < this.width; i++) {
        row_d.push(Infinity);
        if (Math.floor(Math.random() * 10) % 3 == 0)
          row.push(1);
        else
          row.push(0); 
      }
      this.field.push(row);
      this.dist.push(row_d); 
    }
    this.player.y = Math.floor(Math.random() * this.height);
    this.player.x = Math.floor(Math.random() * this.width);
    this.field[this.player.y][this.player.x] = 0;
    var i = this.enemiesCnt, loops = 10;
    while (i > 0 && loops > 0) {
      loops--;
      var y = Math.floor(Math.random() * this.height);
      var x = Math.floor(Math.random() * this.width);
      if (this.field[y][x] == 0) {
        this.field[y][x] = 2;
        this.enemiesCoords.push(y);
        this.enemiesCoords.push(x);  
        loops = 10;
        i--;
      } 
    }
    document.getElementById('enemyCnt').value = this.enemiesCnt - i;
    i = this.fruitsCnt, loops = 10;
    while (i > 0 && loops > 0) {
      loops--;
      var y = Math.floor(Math.random() * this.height);
      var x = Math.floor(Math.random() * this.width);
      if (this.field[y][x] == 0) {
        this.field[y][x] = 3;
        //this.enemiesCoords.push(y);
        //this.enemiesCoords.push(x);  
        loops = 10;
        i--;
      } 
    }
    document.getElementById('fruitsCnt').value = this.fruitsCnt - i;
    //console.log(this);
  },
  setTarget: function (target, keys) {
    this.target = target;
    this.keys = keys;
  },
  isCoordsCorrect: function (x, y) {
    if (x < 0 || y < 0 || x >= this.width || y >= this.height)
      return false;
    return true;
  },
  setInf: function () {
    for (var i = 0; i < this.height; i++)
      for (var j = 0; j < this.width; j++)
        this.dist[i][j] = Infinity;
  },
  redist: function (x, y, d) {
    if (!this.isCoordsCorrect(x, y) || this.field[y][x] == 1)
      return;
    if (d >= this.dist[y][x])
      return;
    this.dist[y][x] = d;
    for (var i = 0; i < 8; i += 2)
      this.redist(x + this.move[i], y + this.move[i + 1], d + 1);
  },
  draw: function () {
    this.setInf();
    this.redist(this.player.x, this.player.y, 0);
    var table = this.target;
    table.innerHTML = '';
    var headTr = document.createElement('tr');
    var headTd = document.createElement('td');
    headTd.setAttribute('colspan', this.width);
    headTd.innerHTML = `Очки ${this.score}`;
    headTd.style = 'text-align: center';
    headTr.appendChild(headTd);
    table.appendChild(headTr);
    for (var j = 0; j < this.height; j++) {
      var tr = document.createElement('tr');
      for (var i = 0; i < this.width; i++) {
        var td = document.createElement('td');
        //td.innerHTML = this.dist[j][i];   
        if (this.field[j][i] == 1)
          td.className = 'wall';
        if (this.field[j][i] == 2)
          td.className = 'enemy';
        if (this.field[j][i] == 3)
          td.className = 'fruit';
        if (this.player.y == j && this.player.x == i) {
          td.className = 'player';
        }  
        tr.appendChild(td); 
      }
      table.appendChild(tr);
    }
  },
  keyboard: function (e) {
    var redraw = false;
    if (e.code == this.keys[3] && this.player.x < this.width - 1 && (this.field[this.player.y][this.player.x + 1] == 0 || this.field[this.player.y][this.player.x + 1] == 3)) {
      this.player.x++, redraw = true;
    }
    if (e.code == this.keys[1] && this.player.x > 0 && (this.field[this.player.y][this.player.x - 1] == 0 || this.field[this.player.y][this.player.x - 1] == 3)) {
      this.player.x--, redraw = true;
    }
    if (e.code == this.keys[0] && this.player.y > 0 && (this.field[this.player.y - 1][this.player.x] == 0 || this.field[this.player.y - 1][this.player.x] == 3)) {
      this.player.y--, redraw = true;
    }
    if (e.code == this.keys[2] && this.player.y < this.height - 1 && (this.field[this.player.y + 1][this.player.x] == 0 || this.field[this.player.y + 1][this.player.x] == 3)) {
      this.player.y++, redraw = true;
    }
    if (redraw) {
      if (this.field[this.player.y][this.player.x] == 3) {
        this.score++;
        this.field[this.player.y][this.player.x] = 0;    
        this.fruitsCnt--;
      } 
      this.draw();
    }
  },
  lose: function () {
    alert('Вы проиграли, ищите ошибки!!!');
  },
  isLose: function () {
    for (var i = 0; i < 2 * this.enemiesCnt; i += 2) {
      if (this.player.y == this.enemiesCoords[i] && this.player.x == this.enemiesCoords[i + 1])
        return true; 
    }
    return false;
  },
  step: function() {
    var lose = false;
    for (var i = 0; i < 2 * this.enemiesCnt; i += 2) {
      var y = this.enemiesCoords[i], x = this.enemiesCoords[i + 1];
      for (var j = 0; j < 8; j += 2) {
        var mx = this.move[j], my = this.move[j + 1];
        if (this.isCoordsCorrect(mx + x, my + y) && this.dist[y + my][x + mx] < this.dist[y][x] && (this.field[my + y][mx + x] == 3 || this.field[my + y][mx + x] == 0)) {
          this.field[y][x] = 0; 
          this.field[y + my][x + mx] = 2;
          this.enemiesCoords[i] += my;
          this.enemiesCoords[i + 1] += mx;
          break;
        }
      }
    }
    this.draw();
    if (this.isLose())
      this.lose();
  }
}
}
var interval_id1, interval_id2;
var maze1 = Maze();
var maze2 = Maze();
function stop() {
  clearInterval(interval_id1);
  clearInterval(interval_id2);
}
function start()
{
  stop();
  maze1.setTarget(document.getElementById('mytable1'), ['KeyW', 'KeyA', 'KeyS', 'KeyD']);
  maze2.setTarget(document.getElementById('mytable2'), ['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight']);
  interval_id1 = setInterval(maze1.step.bind(maze1), 1000);
  interval_id2 = setInterval(maze2.step.bind(maze2), 1000);
  maze1.init();
  maze1.draw();
  maze2.init();
  maze2.draw();  	  	
}

document.body.onkeydown = function (e) {
  console.log(this);
  maze1.keyboard(e);
  maze2.keyboard(e);
}
</script>
</body>
</html>